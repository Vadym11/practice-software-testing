# ---- Build UI ----
FROM node:20-alpine AS build
WORKDIR /app
COPY sprint5/UI/package*.json ./
RUN npm ci --legacy-peer-deps
COPY sprint5/UI/ ./
RUN npm run build

# Collect the exact dist folder that contains index.html into /out
RUN set -eux; \
  out_html="$(find /app/dist -type f -name index.html -print -quit)"; \
  test -n "$out_html"; \
  out_dir="${out_html%/index.html}"; \
  mkdir -p /out; \
  cp -a "$out_dir/." /out/

# ---- Nginx runtime (serves UI + proxies /api to apiweb) ----
FROM nginx:1.27-alpine
RUN rm -rf /usr/share/nginx/html/*
COPY --from=build /out/ /usr/share/nginx/html/
COPY _docker/web.nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx","-g","daemon off;"]