name: K8s Smoke Test (Toolshop)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  k8s-smoke:
    runs-on: ubuntu-latest

    env:
      K8S_NAMESPACE: toolshop-ci-${{ github.run_id }}
      K8S_APP_PORT: "8080"          # local port on the runner
      K8S_SERVICE_PORT: "80"        # port of pst-web Service in the cluster

    steps:
      # 1. Check out repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Authenticate to GCP using a Service Account JSON key
      #    You need to create this secret in GitHub: GCP_SA_KEY
      #    It should contain the full JSON key for a GCP service account
      - name: Set up gcloud auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3. Get GKE credentials (kubectl context)
      #    You also need secrets: GCP_PROJECT_ID, GKE_CLUSTER_NAME, GKE_LOCATION
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_LOCATION }}

      # 4. Create an isolated namespace for this CI run
      - name: Create namespace
        run: |
          echo "Creating namespace: $K8S_NAMESPACE"
          kubectl create namespace "$K8S_NAMESPACE"

      # 4.1. Create slack web hook secret
      - name: Create slack web hook secret
        run: |
          echo "Creating slack web hook secret"
          kubectl create secret generic pst-test-secret \
            -n "$K8S_NAMESPACE" \
            --from-literal=SLACK_WEBHOOK_URL="$SLACK_WEBHOOK_URL"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # 4.2. Apply DB secrets
      - name: Apply DB secrets
        run: |
          echo "Applying db secrets"
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-db-secret.yaml

      # 5. Deploy your app manifests into that namespace
      #    Adjust the paths below to match your k8s manifest locations
      - name: Deploy Toolshop app
        run: |
          set -e
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-db.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-api.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-apiweb.yaml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-web.yaml
          # Optional: cron worker, if you want it in CI
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-cron.yaml

      # 6. Wait for the key Deployments to be ready
      - name: Wait for deployments to be ready
        run: |
          set -e
          kubectl rollout status deployment/pst-db  -n "$K8S_NAMESPACE" --timeout=120s || true
          kubectl rollout status deployment/pst-api -n "$K8S_NAMESPACE" --timeout=180s
          kubectl rollout status deployment/pst-web -n "$K8S_NAMESPACE" --timeout=180s

      # # 7. Port-forward the pst-web service to the runner
      # - name: Port-forward pst-web
      #   run: |
      #     set -e
      #     echo "Starting port-forward from svc/pst-web:$K8S_SERVICE_PORT to localhost:$K8S_APP_PORT"
      #     kubectl port-forward -n "$K8S_NAMESPACE" svc/pst-web "$K8S_APP_PORT:$K8S_SERVICE_PORT" >pf.log 2>&1 &
      #     echo $! > pf.pid
      #     # Give the port-forward a moment to establish
      #     sleep 10
      #     echo "Port-forward PID: $(cat pf.pid)"

      # # 8. Simple smoke test: hit the UI via curl
      # - name: Smoke test via curl
      #   run: |
      #     set -e
      #     echo "Requesting http://127.0.0.1:${K8S_APP_PORT}/"
      #     curl -v --fail "http://127.0.0.1:${K8S_APP_PORT}/" | head -40

      # 8.1. Apply Playwright test job
      - name: Apply Playwright test job
        run: |
          set -e
          echo "Applying Playwright test job..."
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/pst-playwright.yaml

      # 8.2. Wait for Playwright test job to finish
      - name: Wait for Playwright test job to finish
        run: |
          set -e
          echo "Waiting for Playwright test job to complete..."

          # First wait for completion
          if kubectl wait --for=condition=complete job/pst-playwright-tests \
              -n "$K8S_NAMESPACE" --timeout=120s; then
            echo "Playwright job completed successfully."
          else
            echo "Job did not reach 'Complete'. Checking if it failed..."
            kubectl describe job/pst-playwright-tests -n "$K8S_NAMESPACE"
            kubectl logs job/pst-playwright-tests -n "$K8S_NAMESPACE"
            exit 1
          fi

          echo "==== Playwright job logs ===="
          kubectl logs job/pst-playwright-tests -n "$K8S_NAMESPACE" || true

      # (Later youâ€™ll add a step here to run Playwright against BASE_URL=http://127.0.0.1:${K8S_APP_PORT})

      # 9. Stop port-forward (always attempt, even if previous steps failed)
      - name: Stop port-forward
        if: always()
        run: |
          if [ -f pf.pid ]; then
            echo "Stopping port-forward PID $(cat pf.pid)"
            kill "$(cat pf.pid)" || true
          else
            echo "No pf.pid file found, nothing to stop."
          fi

      # 10. Delete the namespace (cleanup)
      - name: Delete namespace
        if: always()
        run: |
          echo "Deleting namespace: $K8S_NAMESPACE"
          kubectl delete namespace "$K8S_NAMESPACE" --wait=false || true